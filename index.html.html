<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHub - Connect & Create</title>
    <meta name="description" content="Connect with friends and express yourself with creative fonts and styles">
    <meta name="theme-color" content="#667eea">
    <!-- ChatHub - Community-Moderated Chat Platform -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdEh1YiIsInNob3J0X25hbWUiOiJDaGF0SHViIiwiZGVzY3JpcHRpb24iOiJDb25uZWN0IHdpdGggZnJpZW5kcyBhbmQgZXhwcmVzcyB5b3Vyc2VsZiB3aXRoIGNyZWF0aXZlIGZvbnRzIGFuZCBzdHlsZXMiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzY2N2VlYSIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhZMmx5WTJ4bElHTjRQU0kyTUNJZ1kza2lQU0kyTUNJZ2NqMGlOVEFpSUdacGJHdzlJaU0yTmpkbFpXRWlMejQ4ZEdWNGRDQjRQU0kyTUNJZ2VUMGlOekFpSUdacGJHdzlJaU0zTmpSaVlUSWlJR1p2Ym5RdGMybDZaVDBpTWpBaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQaU5EYUdGMFNIVmlQQzkwWlhoMFBqd3ZjM1puUGc9PSIsInNpemVzIjoiMTIweDEyMCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklqNDhZMmx5WTJ4bElHTjRQU0l4TWpnaUlHTjVQU0l4TWpnaUlISTlJakV3TUNJZ1ptbHNiRDBpSXpZMk4yVmxZU0l2UGp4MFpYaDBJSGc5SWpFeU9DSWdlVDBpTVRNNElDSWdabWxzYkQwaUl6YzJOR0poTWlJZ1ptOXVkQzF6YVhwbFBTSXpNaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK0kwTm9ZWFJJZFdJOEwzUmxlSFErUEM5emRtYytQZz09Iiwic2l6ZXMiOiIyNTZ4MjU2IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzY2N2VlYTtzdG9wLW9wYWNpdHk6MSIgLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIHJ4PSIyNCIgZmlsbD0idXJsKCNiZykiLz48Y2lyY2xlIGN4PSI0NSIgY3k9IjQ1IiByPSIxOCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjkpIi8+PGNpcmNsZSBjeD0iNzUiIGN5PSI0NSIgcj0iMTgiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC43KSIvPjxjaXJjbGUgY3g9IjYwIiBjeT0iNzUiIHI9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOCkiLz48dGV4dCB4PSI0NSIgeT0iNTIiIGZpbGw9IiM2NjdlZWEiIGZvbnQtc2l6ZT0iMTYiIGZvbnQtd2VpZ2h0PSJib2xkIiBmb250LWZhbWlseT0iSW50ZXIiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkM8L3RleHQ+PHRleHQgeD0iNzUiIHk9IjUyIiBmaWxsPSIjNjY3ZWVhIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZm9udC1mYW1pbHk9IkludGVyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5IPC90ZXh0Pjx0ZXh0IHg9IjYwIiB5PSI4MiIgZmlsbD0iIzY2N2VlYSIgZm9udC1zaXplPSIxNiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtZmFtaWx5PSJJbnRlciIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QjwvdGV4dD48cGF0aCBkPSJNMzAgOTVRNjAgMTA1IDkwIDk1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC42KSIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Caveat:wght@400;700&family=Orbitron:wght@400;700&family=Dancing+Script:wght@400;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --bg-color: #f8faff;
            --text-color: #2d3748;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 10px 40px rgba(102, 126, 234, 0.15);
            --hover-shadow: 0 15px 50px rgba(102, 126, 234, 0.25);
            --accent-color: #667eea;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --warning-color: #ed8936;
        }

        [data-theme="dark"] {
            --bg-color: #0f0f23;
            --text-color: #e2e8f0;
            --card-bg: rgba(26, 32, 44, 0.95);
            --border-color: #2d3748;
            --input-bg: #1a202c;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            --hover-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundFloat 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-10px) rotate(1deg); }
            66% { transform: translateY(5px) rotate(-1deg); }
        }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 200% 100%;
            animation: headerGlow 3s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes logoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .install-btn, .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .install-btn::before, .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .install-btn:hover, .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .install-btn:hover::before, .nav-btn:hover::before {
            left: 100%;
        }

        .install-btn:active, .nav-btn:active {
            transform: translateY(0px);
        }

        .install-btn.show {
            display: block;
        }

        .nav-menu {
            display: flex;
            gap: 0.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .main-container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Login/Register Page */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }

        .auth-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 8px;
            overflow: hidden;
            background: var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary-gradient);
            color: white;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.2px;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .report-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .report-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Chat Page */
        .chat-layout {
            display: flex;
            gap: 1rem;
            height: 80vh;
        }

        .chat-sidebar {
            width: 320px;
            background: var(--card-bg);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            margin: 0;
            color: var(--text-color);
        }

        .new-group-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .new-group-btn:hover {
            transform: translateY(-1px);
        }

        .chat-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .chat-tab.active {
            background: var(--primary-gradient);
            color: white;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .chat-item:hover {
            background: var(--input-bg);
        }

        .chat-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 800;
            margin-bottom: 0.25rem;
            color: var(--text-color);
            font-size: 1rem;
            letter-spacing: 0.2px;
        }

        .chat-item.active .chat-name {
            color: white;
        }

        .chat-preview {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item.active .chat-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chat-status.online {
            background: #10b981;
        }

        .chat-status.offline {
            background: #6b7280;
        }

        .group-count {
            font-size: 0.8rem;
            color: #666;
            flex-shrink: 0;
        }

        .chat-item.active .group-count {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-area {
            flex: 1;
            background: var(--card-bg);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-header-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .chat-header-name {
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
        }

        .chat-header-status {
            font-size: 0.9rem;
            color: #666;
        }

        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-action-btn {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-action-btn:hover {
            border-color: #667eea;
        }

        .welcome-message {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-color);
        }

        .welcome-message h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .welcome-message p {
            color: #666;
            line-height: 1.6;
        }

        .messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            background: var(--primary-gradient);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.other {
            background: var(--border-color);
            color: var(--text-color);
            align-self: flex-start;
        }

        .message-input-area {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .font-panel {
            width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .font-panel h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .font-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .font-option {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .font-option:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .font-option.active {
            border-color: #667eea;
            background: var(--primary-gradient);
            color: white;
        }

        .font-casual { font-family: 'Caveat', cursive; font-size: 1.1rem; }
        .font-tech { font-family: 'Orbitron', monospace; }
        .font-elegant { font-family: 'Dancing Script', cursive; font-size: 1.1rem; }
        .font-code { font-family: 'Courier Prime', monospace; }
        .font-normal { font-family: 'Inter', sans-serif; }

        .style-options {
            margin-top: 1.5rem;
        }

        .style-toggles {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .style-toggle {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-color);
            transition: all 0.2s;
        }

        .style-toggle:hover {
            border-color: #667eea;
        }

        .style-toggle.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .preview-area {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .preview-text {
            font-size: 1.1rem;
            color: var(--text-color);
        }

        /* Friends Page */
        .friends-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .search-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .friend-card {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }

        .friend-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .friend-name {
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
            letter-spacing: 0.2px;
        }

        .friend-status {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .add-friend-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .add-friend-btn:hover {
            transform: translateY(-1px);
        }

        /* Settings Page */
        .settings-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 0 auto;
        }

        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .profile-upload {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .profile-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .upload-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .save-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .save-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes sparkle {
            0%, 100% {
                transform: rotate(0deg) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: rotate(180deg) scale(1.1);
                opacity: 0.6;
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        @media (max-width: 768px) {
            .chat-layout {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 300px;
                order: -1;
            }
            
            .font-panel {
                width: 100%;
                order: 2;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .nav-menu {
                flex-direction: column;
                gap: 0.25rem;
            }

            .friends-grid {
                grid-template-columns: 1fr;
            }

            .chat-header {
                padding: 1rem;
            }

            .chat-header-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .invite-grid {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #feca57 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent); animation: logoSpin 8s linear infinite;"></div>
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" style="position: relative; z-index: 1;">
                    <defs>
                        <linearGradient id="chatGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#f8f9ff;stop-opacity:0.95" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.9" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="1" result="coloredBlur"/>
                            <feMerge> 
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- Chat bubbles with gradient and glow -->
                    <circle cx="10" cy="10" r="4.5" fill="url(#chatGradient)" filter="url(#glow)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                    <circle cx="18" cy="10" r="4.5" fill="url(#chatGradient)" filter="url(#glow)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                    <circle cx="14" cy="18" r="4.5" fill="url(#chatGradient)" filter="url(#glow)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                    
                    <!-- Letters with better styling -->
                    <text x="10" y="12.5" fill="#4a5568" font-size="4.5" font-weight="900" font-family="Inter" text-anchor="middle" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">C</text>
                    <text x="18" y="12.5" fill="#4a5568" font-size="4.5" font-weight="900" font-family="Inter" text-anchor="middle" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">H</text>
                    <text x="14" y="20.5" fill="#4a5568" font-size="4.5" font-weight="900" font-family="Inter" text-anchor="middle" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">B</text>
                    
                    <!-- Connection lines with glow -->
                    <path d="M7 22Q14 24.5 21 22" stroke="rgba(255,255,255,0.8)" stroke-width="1.2" fill="none" stroke-linecap="round" filter="url(#glow)"/>
                    <path d="M6 8Q14 6 22 8" stroke="rgba(255,255,255,0.6)" stroke-width="1" fill="none" stroke-linecap="round"/>
                    
                    <!-- Sparkle effects -->
                    <circle cx="6" cy="6" r="0.8" fill="rgba(255,255,255,0.9)" style="animation: sparkle 2s ease-in-out infinite;">
                        <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="22" cy="6" r="0.6" fill="rgba(255,255,255,0.8)" style="animation: sparkle 2.5s ease-in-out infinite;">
                        <animate attributeName="opacity" values="0.2;0.9;0.2" dur="2.5s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="4" cy="20" r="0.7" fill="rgba(255,255,255,0.85)" style="animation: sparkle 1.8s ease-in-out infinite;">
                        <animate attributeName="opacity" values="0.4;1;0.4" dur="1.8s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </div>
            <h1 style="margin: 0; color: white; font-size: 1.8rem; font-weight: 600;">ChatHub</h1>
        </div>
        <div class="header-actions">
            <div class="nav-menu" id="navMenu" style="display: none;">
                <button class="nav-btn" onclick="showPage('chat')">üí¨ Chat</button>
                <button class="nav-btn" onclick="showPage('friends')">üë• Friends</button>
                <button class="nav-btn" onclick="showPage('browse')">üåç Browse</button>
                <button class="nav-btn" onclick="showPage('settings')">‚öôÔ∏è Settings</button>
                <button class="nav-btn" onclick="logout()">üö™ Logout</button>
            </div>
            <div class="user-profile" id="userProfile" style="display: none;">
                <div class="profile-pic" id="headerProfilePic">üë§</div>
                <span id="headerUsername">User</span>
            </div>
            <button class="install-btn" id="installBtn" onclick="installApp()" style="display: none;">
                üì± Install App
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Profile Setup Page -->
        <div class="page" id="profileSetupPage">
            <div class="auth-container">
                <div class="auth-card">
                    <h2 style="text-align: center; margin-bottom: 2rem;">üéâ Welcome to ChatHub!</h2>
                    <p style="text-align: center; margin-bottom: 2rem; color: var(--text-color);">
                        Let's set up your profile to get started
                    </p>
                    
                    <form id="profileSetupForm">
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="setupDisplayName" required placeholder="How should others see you?">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="setupUsername" required placeholder="Choose a unique username">
                        </div>
                        <div class="form-group">
                            <label>Profile Picture</label>
                            <div class="profile-upload">
                                <div class="profile-preview" id="setupProfilePreview">üì∑</div>
                                <div>
                                    <input type="file" id="setupProfilePicInput" accept="image/*" style="display: none;" onchange="handleSetupProfilePicture(event)">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('setupProfilePicInput').click()">
                                        üì∑ Choose Picture
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="allowFriendRequests" checked>
                                Allow others to find me and send friend requests
                            </label>
                        </div>
                        <button type="submit" class="auth-btn">üöÄ Complete Setup</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Login/Register Page -->
        <div class="page active" id="authPage">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                        <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                    </div>

                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="auth-btn">Login</button>
                    </form>

                    <form id="registerForm" style="display: none;">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="registerUsername" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="registerPassword" required>
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="auth-btn">Create Account</button>
                    </form>

                    <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <p style="color: #666; font-size: 0.9rem;">
                            Join our community and start chatting with friends! üéâ
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div class="page" id="chatPage">
            <div class="chat-layout">
                <!-- Friends & Groups Sidebar -->
                <div class="chat-sidebar">
                    <div class="sidebar-header">
                        <h3>üí¨ Chats</h3>
                        <button class="new-group-btn" onclick="showCreateGroup()">‚ûï New Group</button>
                    </div>
                    
                    <div class="chat-tabs">
                        <button class="chat-tab active" onclick="switchChatTab('friends')">üë• Friends</button>
                        <button class="chat-tab" onclick="switchChatTab('groups')">üè† Groups</button>
                    </div>
                    
                    <div class="chat-list" id="friendsChatList">
                        <div style="text-align: center; padding: 3rem 1rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--text-color);">No Friends Yet</h3>
                            <p style="font-size: 0.9rem; line-height: 1.4;">Add friends from the Friends page to start chatting!</p>
                        </div>
                    </div>
                    
                    <div class="chat-list" id="groupsChatList" style="display: none;">
                        <div id="noGroupsMessage" style="text-align: center; padding: 3rem 1rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üè†</div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--text-color);">No Groups Yet</h3>
                            <p style="font-size: 0.9rem; line-height: 1.4;">Create your first group to chat with multiple friends!</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area">
                    <div class="chat-header" id="chatHeader">
                        <div class="chat-header-info">
                            <div class="chat-header-avatar" id="chatHeaderAvatar">üëã</div>
                            <div>
                                <div class="chat-header-name" id="chatHeaderName">Select a friend to start chatting</div>
                                <div class="chat-header-status" id="chatHeaderStatus">Choose from your friends list</div>
                            </div>
                        </div>
                        <div class="chat-header-actions" id="chatHeaderActions">
                            <button class="header-action-btn" onclick="toggleChatInfo()">‚ÑπÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="messages" id="messages">
                        <div class="welcome-message">
                            <h3>üëã Welcome to ChatHub!</h3>
                            <p>Select a friend from the sidebar to start chatting, or create a new group to chat with multiple friends at once.</p>
                        </div>
                    </div>
                    
                    <div class="message-input-area" id="messageInputArea" style="display: none;">
                        <div class="input-container">
                            <button class="header-action-btn" onclick="document.getElementById('imageInput').click()" style="margin-right: 0.5rem;" title="Send Image">
                                üì∑
                            </button>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            <textarea 
                                id="messageInput" 
                                class="message-input" 
                                placeholder="Type your message... Express yourself!"
                                rows="1"
                            ></textarea>
                            <button class="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Font Panel -->
                <div class="font-panel" id="fontPanel" style="display: none;">
                    <h3>üé® Style Your Text</h3>
                    
                    <div class="font-options">
                        <div class="font-option font-normal active" onclick="selectFont('normal')">
                            Regular Font
                        </div>
                        <div class="font-option font-casual" onclick="selectFont('casual')">
                            Casual & Fun
                        </div>
                        <div class="font-option font-tech" onclick="selectFont('tech')">
                            Tech & Futuristic
                        </div>
                        <div class="font-option font-elegant" onclick="selectFont('elegant')">
                            Elegant Script
                        </div>
                        <div class="font-option font-code" onclick="selectFont('code')">
                            Code Style
                        </div>
                    </div>

                    <div class="style-options">
                        <h4 style="margin-bottom: 0.5rem;">Text Effects</h4>
                        <div class="style-toggles">
                            <div class="style-toggle" onclick="toggleStyle('bold')">Bold</div>
                            <div class="style-toggle" onclick="toggleStyle('italic')">Italic</div>
                            <div class="style-toggle" onclick="toggleStyle('large')">Large</div>
                        </div>
                    </div>

                    <div class="preview-area">
                        <h4 style="margin-bottom: 0.5rem;">Preview:</h4>
                        <div class="preview-text font-normal" id="preview">
                            Your message will look like this!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friends Page -->
        <div class="page" id="friendsPage">
            <div class="friends-container">
                <div class="friends-header">
                    <h2>üë• My Friends</h2>
                    <button class="new-group-btn" onclick="showPage('browse')" style="background: var(--success-gradient);">
                        üåç Browse People
                    </button>
                </div>

                <div class="invite-section" style="background: var(--card-bg); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">üé´ Invite Friends</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;" class="invite-grid">
                        <div style="text-align: center;">
                            <h4 style="color: var(--text-color); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                üì§ <span>Share Your Code</span>
                            </h4>
                            <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border-color); margin-bottom: 1rem;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--accent-color); font-family: 'Courier Prime', monospace; letter-spacing: 2px;" id="myInviteCode">
                                    LOADING...
                                </div>
                            </div>
                            <button class="auth-btn" onclick="copyMyInviteCode()" style="margin: 0; width: 100%; background: var(--success-gradient);">
                                üìã Copy My Code
                            </button>
                        </div>
                        
                        <div style="text-align: center;">
                            <h4 style="color: var(--text-color); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                üì• <span>Enter Friend's Code</span>
                            </h4>
                            <div style="margin-bottom: 1rem;">
                                <input type="text" id="friendInviteCode" placeholder="Enter invite code..." 
                                       style="width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-size: 1rem; text-align: center; font-family: 'Courier Prime', monospace; letter-spacing: 1px; text-transform: uppercase;">
                            </div>
                            <button class="auth-btn" onclick="useInviteCode()" style="margin: 0; width: 100%; background: var(--primary-gradient);">
                                ü§ù Add Friend
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                        <p style="color: #666; font-size: 0.9rem; margin: 0;">
                            üí° Share your code with friends or enter theirs to instantly become friends!
                        </p>
                    </div>
                </div>

                <div class="friends-grid" id="myFriendsGrid">
                    <!-- My friends will be populated here -->
                </div>

                <div id="noFriendsMessage" style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 20px; margin: 2rem 0; border: 2px solid rgba(102, 126, 234, 0.2);">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: bounce 2s infinite;">üë•</div>
                    <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.5rem;">No Friends Yet!</h3>
                    <p style="color: var(--text-color); font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem;">
                        Use the invite codes above or browse people to start building your community! üåü
                    </p>
                    <button class="auth-btn" onclick="showPage('browse')" style="margin: 0; width: auto; padding: 0.75rem 2rem; background: var(--success-gradient);">
                        üåç Browse People
                    </button>
                </div>
            </div>
        </div>

        <!-- Browse Page -->
        <div class="page" id="browsePage">
            <div class="friends-container">
                <div class="friends-header">
                    <h2>üåç Browse People</h2>
                </div>

                <div id="pioneerMessage" style="display: none; text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border-radius: 20px; margin-bottom: 2rem; border: 2px solid rgba(255, 215, 0, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%); animation: sparkle 4s ease-in-out infinite;"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; animation: bounce 2s infinite;">üöÄ</div>
                        <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.8rem; font-weight: 700;">üéâ You're the Pioneer! üéâ</h3>
                        <p style="color: var(--text-color); font-size: 1.2rem; line-height: 1.6; margin-bottom: 1.5rem; font-weight: 500;">
                            Congratulations! You're the very first person to join ChatHub! üåü<br>
                            <span style="font-size: 1rem; opacity: 0.8;">Share your invite code from the Friends page to start building your community.</span>
                        </p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="auth-btn" onclick="showPage('friends')" style="margin: 0; width: auto; padding: 0.75rem 2rem; background: var(--warning-gradient); box-shadow: 0 8px 25px rgba(255, 165, 0, 0.3);">
                                üé´ Go to Friends Page
                            </button>
                            <button class="auth-btn" onclick="showFirstUserTips()" style="margin: 0; width: auto; padding: 0.75rem 2rem; background: var(--success-gradient); box-shadow: 0 8px 25px rgba(67, 233, 123, 0.3);">
                                üí° Getting Started Tips
                            </button>
                        </div>
                    </div>
                </div>

                <div class="search-bar" id="browseSearchSection">
                    <input type="text" class="search-input" placeholder="Search for people by username or name..." id="browseSearch">
                    <button class="search-btn" onclick="searchBrowse()" style="background: var(--success-gradient);">üîç Search</button>
                </div>

                <div class="friends-grid" id="browseGrid">
                    <!-- Browse results will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="settingsPage">
            <div class="settings-container">
                <h2>‚öôÔ∏è Settings</h2>

                <div class="settings-section">
                    <h3>üë§ Profile</h3>
                    <div class="profile-upload">
                        <div class="profile-preview" id="profilePreview">üë§</div>
                        <div>
                            <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicture(event)">
                            <button class="upload-btn" onclick="document.getElementById('profilePicInput').click()">
                                üì∑ Change Picture
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="settingsDisplayName" placeholder="How others see you">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="settingsUsername" placeholder="Your unique username">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="settingsAllowFriendRequests">
                            Allow others to find me and send friend requests
                        </label>
                    </div>
                </div>



                <div class="settings-section">
                    <h3>üé® Appearance</h3>
                    <div class="theme-toggle">
                        <span>Dark Mode</span>
                        <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üö´ Blocked Users</h3>
                    <div id="blockedUsersList">
                        <p style="color: #666; font-style: italic;">No blocked users</p>
                    </div>
                </div>

                <button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentFont = 'normal';
        let currentStyles = { bold: false, italic: false, large: false };
        let isDarkMode = false;
        let deferredPrompt;
        let allUsers = [];
        let currentChat = null;
        let userFriends = [];
        let userGroups = [];
        let chatMessages = {};
        let blockedUsers = [];
        let friendRequests = [];
        let myFriends = [];

        // User reporting and moderation
        let reportedUsers = JSON.parse(localStorage.getItem('chatHubReportedUsers') || '[]');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadAllUsers();
            initializeSampleUsers();
            updatePreview();
            
            // Check for invite code in URL
            checkInviteCode();
            
            // Setup form handlers
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('profileSetupForm').addEventListener('submit', handleProfileSetup);
            
            // Setup message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Initialize complete
        });

        function checkInviteCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            
            if (inviteCode) {
                // Store invite code for later use
                localStorage.setItem('chatHubPendingInvite', inviteCode);
                
                // Clean URL
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Show invite welcome message
                showInviteWelcome(inviteCode);
            }
        }

        function showInviteWelcome(inviteCode) {
            const inviteCodes = JSON.parse(localStorage.getItem('chatHubInviteCodes') || '{}');
            const inviteData = inviteCodes[inviteCode];
            
            if (!inviteData) {
                // Invalid or expired invite
                showInvalidInvite();
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: sparkle 2s infinite;">üéâ</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.8rem;">You're Invited!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6; font-size: 1.1rem;">
                        <strong>${inviteData.inviterName}</strong> (@${inviteData.inviterUsername}) invited you to join ChatHub! 
                    </p>
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid rgba(102, 126, 234, 0.2);">
                        <p style="color: var(--text-color); font-size: 1rem; line-height: 1.5; margin: 0;">
                            ‚ú® Chat with creative fonts and styles<br>
                            üë• Connect with friends and groups<br>
                            üé® Express yourself uniquely
                        </p>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="this.closest('div').parentElement.remove(); switchAuthTab('register');" 
                                style="padding: 0.75rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3); font-size: 1rem;">
                            üöÄ Join ChatHub
                        </button>
                        <button onclick="this.closest('div').parentElement.remove();" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                            Maybe Later
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showInvalidInvite() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3 style="color: var(--warning-color); margin-bottom: 1rem; font-size: 1.5rem;">Invalid Invite</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6;">
                        This invite link is invalid or has expired. You can still join ChatHub by creating an account!
                    </p>
                    <button onclick="this.closest('div').parentElement.remove();" 
                            style="padding: 0.75rem 2rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                        ‚úÖ Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 4000);
        }

        // Initialize users array (starts empty for fresh experience)
        function initializeSampleUsers() {
            // No demo users - app starts completely fresh
            if (!allUsers) {
                allUsers = [];
            }
        }

        // Load all users from localStorage
        function loadAllUsers() {
            const savedUsers = localStorage.getItem('chatHubAllUsers');
            if (savedUsers) {
                allUsers = JSON.parse(savedUsers);
            }
        }

        // Save all users to localStorage
        function saveAllUsers() {
            localStorage.setItem('chatHubAllUsers', JSON.stringify(allUsers));
        }

        // Authentication functions
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                tabs[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                tabs[1].classList.add('active');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Demo login - in real app, this would validate against a server
            if (email && password) {
                // Check if user exists in our system
                const existingUser = allUsers.find(u => u.email === email);
                if (existingUser) {
                    currentUser = existingUser;
                    localStorage.setItem('chatHubUser', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    alert('User not found. Please register first or sign in with Google/Apple.');
                }
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Check if user already exists
            if (allUsers.find(u => u.email === email)) {
                alert('User with this email already exists!');
                return;
            }
            
            // Demo registration
            if (username && email && password) {
                const newUser = {
                    id: Date.now(),
                    username: username,
                    displayName: username,
                    email: email,
                    avatar: 'üë§',
                    allowFriendRequests: true,
                    provider: 'email',
                    setupComplete: false
                };
                
                currentUser = newUser;
                localStorage.setItem('chatHubUser', JSON.stringify(currentUser));
                showProfileSetup();
            }
        }

        // AI Content Moderation System
        function reportUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const reasons = [
                'Inappropriate profile picture',
                'Inappropriate username',
                'Offensive display name',
                'Spam or fake account',
                'Other inappropriate content'
            ];
            
            let reasonsHtml = reasons.map((reason, index) => 
                `<label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                    <input type="radio" name="reportReason" value="${index}" style="margin-right: 0.5rem;">
                    ${reason}
                </label>`
            ).join('');
            
            const reportModal = document.createElement('div');
            reportModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            reportModal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 16px; max-width: 400px; width: 90%;">
                    <h3 style="margin-bottom: 1rem; color: var(--text-color);">üö® Report User</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-color);">
                        Reporting: <strong>${user.displayName}</strong> (@${user.username})
                    </p>
                    <div style="margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 0.5rem; color: var(--text-color); font-weight: 500;">Reason for report:</p>
                        ${reasonsHtml}
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.5rem 1rem; background: var(--border-color); border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="submitReport('${userId}', this)" 
                                style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üö® Submit Report
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reportModal);
        }
        
        function submitReport(userId, buttonElement) {
            const modal = buttonElement.closest('div').parentElement;
            const selectedReason = modal.querySelector('input[name="reportReason"]:checked');
            
            if (!selectedReason) {
                alert('Please select a reason for reporting.');
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            const reasons = [
                'Inappropriate profile picture',
                'Inappropriate username', 
                'Offensive display name',
                'Spam or fake account',
                'Other inappropriate content'
            ];
            
            // Simulate AI moderation decision
            buttonElement.innerHTML = 'ü§ñ AI Reviewing...';
            buttonElement.disabled = true;
            
            setTimeout(() => {
                const aiDecision = simulateAIModeration(user, reasons[selectedReason.value]);
                
                if (aiDecision.action === 'remove') {
                    // Remove user from system
                    allUsers = allUsers.filter(u => u.id !== userId);
                    saveAllUsers();
                    
                    // Refresh friends list
                    populateFriends();
                    
                    modal.innerHTML = `
                        <div style="background: var(--card-bg); padding: 2rem; border-radius: 16px; text-align: center;">
                            <h3 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è User Removed</h3>
                            <p style="color: var(--text-color); margin-bottom: 1rem;">
                                Our AI has reviewed the report and determined that <strong>${user.displayName}</strong> 
                                violated our community guidelines.
                            </p>
                            <p style="color: var(--text-color); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <strong>Reason:</strong> ${aiDecision.reason}
                            </p>
                            <button onclick="this.closest('div').parentElement.remove()" 
                                    style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‚úÖ Thank You
                            </button>
                        </div>
                    `;
                } else {
                    modal.innerHTML = `
                        <div style="background: var(--card-bg); padding: 2rem; border-radius: 16px; text-align: center;">
                            <h3 style="color: #10b981; margin-bottom: 1rem;">‚úÖ Report Reviewed</h3>
                            <p style="color: var(--text-color); margin-bottom: 1rem;">
                                Our AI has reviewed the report for <strong>${user.displayName}</strong> 
                                and found no violation of our community guidelines.
                            </p>
                            <p style="color: var(--text-color); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <strong>AI Analysis:</strong> ${aiDecision.reason}
                            </p>
                            <button onclick="this.closest('div').parentElement.remove()" 
                                    style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‚úÖ Understood
                            </button>
                        </div>
                    `;
                }
            }, 3000);
        }
        
        function simulateAIModeration(user, reportReason) {
            // Simulate AI content moderation logic
            const inappropriateUsernames = [
                'badword', 'inappropriate', 'offensive', 'hate', 'spam', 'fake',
                'admin', 'moderator', 'chathub', 'official', 'support'
            ];
            
            const inappropriateDisplayNames = [
                'hitler', 'nazi', 'terrorist', 'killer', 'death', 'hate',
                'fuck', 'shit', 'damn', 'bitch', 'ass', 'sex'
            ];
            
            // Check username
            const usernameCheck = inappropriateUsernames.some(word => 
                user.username.toLowerCase().includes(word)
            );
            
            // Check display name
            const displayNameCheck = inappropriateDisplayNames.some(word => 
                user.displayName.toLowerCase().includes(word)
            );
            
            // Check if avatar contains inappropriate content (simplified check)
            const avatarCheck = user.avatar && (
                user.avatar.includes('üîû') || 
                user.avatar.includes('üíÄ') ||
                user.avatar.includes('üñï')
            );
            
            if (usernameCheck) {
                return {
                    action: 'remove',
                    reason: 'Username contains inappropriate or reserved terms that violate our community guidelines.'
                };
            }
            
            if (displayNameCheck) {
                return {
                    action: 'remove', 
                    reason: 'Display name contains offensive language that is not suitable for our community.'
                };
            }
            
            if (avatarCheck) {
                return {
                    action: 'remove',
                    reason: 'Profile picture contains inappropriate content that violates our community standards.'
                };
            }
            
            // Random decision for edge cases (90% keep, 10% remove for demonstration)
            if (Math.random() < 0.1) {
                return {
                    action: 'remove',
                    reason: 'Content flagged by our AI as potentially inappropriate based on community reports and analysis.'
                };
            }
            
            return {
                action: 'keep',
                reason: 'After analysis, the reported content appears to comply with our community guidelines. The username, display name, and profile picture are appropriate.'
            };
        }

        // Profile setup
        function handleProfileSetup(e) {
            e.preventDefault();
            
            const displayName = document.getElementById('setupDisplayName').value;
            const username = document.getElementById('setupUsername').value;
            const allowFriendRequests = document.getElementById('allowFriendRequests').checked;
            
            // Check if username is taken
            if (allUsers.find(u => u.username === username && u.id !== currentUser.id)) {
                alert('Username is already taken! Please choose another one.');
                return;
            }
            
            // AI Content Scanning for new users
            const aiScanResult = performAIContentScan(displayName, username, currentUser.avatar);
            
            if (!aiScanResult.approved) {
                alert(`‚ùå Profile not approved: ${aiScanResult.reason}\n\nPlease choose appropriate content and try again.`);
                return;
            }
            
            currentUser.displayName = displayName;
            currentUser.username = username;
            currentUser.allowFriendRequests = allowFriendRequests;
            currentUser.setupComplete = true;
            currentUser.aiApproved = true;
            currentUser.scanDate = new Date();
            
            // Process pending invite if exists
            processPendingInvite();
            
            // Add to all users if not already there
            const existingIndex = allUsers.findIndex(u => u.id === currentUser.id);
            if (existingIndex >= 0) {
                allUsers[existingIndex] = currentUser;
            } else {
                allUsers.push(currentUser);
            }
            
            saveAllUsers();
            localStorage.setItem('chatHubUser', JSON.stringify(currentUser));
            
            // Show success message for AI approval
            if (aiScanResult.approved) {
                showAIApprovalMessage();
                setTimeout(() => {
                    showMainApp();
                }, 2000);
            }
        }

        function processPendingInvite() {
            const pendingInvite = localStorage.getItem('chatHubPendingInvite');
            if (!pendingInvite) return;
            
            const inviteCodes = JSON.parse(localStorage.getItem('chatHubInviteCodes') || '{}');
            const inviteData = inviteCodes[pendingInvite];
            
            if (inviteData && !inviteData.used) {
                // Mark invite as used
                inviteData.used = true;
                inviteData.usedBy = currentUser.id;
                inviteData.usedAt = new Date().toISOString();
                localStorage.setItem('chatHubInviteCodes', JSON.stringify(inviteCodes));
                
                // Find the inviter and add them as a friend
                const inviter = allUsers.find(u => u.id === inviteData.inviterId);
                if (inviter) {
                    // Add inviter to new user's friends list
                    if (!myFriends.find(f => f.id === inviter.id)) {
                        myFriends.push(inviter);
                        localStorage.setItem('chatHubMyFriends', JSON.stringify(myFriends));
                    }
                    
                    // Add new user to inviter's friends list (simulate mutual friendship)
                    const inviterFriends = JSON.parse(localStorage.getItem(`chatHubFriends_${inviter.id}`) || '[]');
                    if (!inviterFriends.find(f => f.id === currentUser.id)) {
                        inviterFriends.push({
                            id: currentUser.id,
                            displayName: currentUser.displayName,
                            username: currentUser.username,
                            avatar: currentUser.avatar
                        });
                        localStorage.setItem(`chatHubFriends_${inviter.id}`, JSON.stringify(inviterFriends));
                    }
                    
                    // Show successful invite connection
                    setTimeout(() => {
                        showInviteConnectionSuccess(inviter);
                    }, 3000);
                }
            }
            
            // Clean up pending invite
            localStorage.removeItem('chatHubPendingInvite');
        }

        function showInviteConnectionSuccess(inviter) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: sparkle 2s infinite;">ü§ù</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">Connected! üéâ</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6;">
                        You're now friends with <strong>${inviter.displayName}</strong> who invited you to ChatHub! 
                    </p>
                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                            ${inviter.avatar}
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-color);">${inviter.displayName}</div>
                            <div style="font-size: 0.9rem; color: #666;">@${inviter.username}</div>
                        </div>
                    </div>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                        üí¨ Start chatting from the Friends page or Chat section!
                    </p>
                    <button onclick="this.closest('div').parentElement.remove(); showPage('friends');" 
                            style="padding: 0.75rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                        üë• View Friends
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 5000);
        }

        function performAIContentScan(displayName, username, avatar) {
            // Simulate AI content moderation for new users
            const inappropriateWords = [
                'admin', 'moderator', 'chathub', 'official', 'support', 'bot',
                'fuck', 'shit', 'damn', 'bitch', 'ass', 'sex', 'porn', 'nude',
                'hitler', 'nazi', 'terrorist', 'kill', 'death', 'hate', 'racist'
            ];
            
            const reservedWords = ['admin', 'moderator', 'chathub', 'official', 'support', 'bot', 'system'];
            
            // Check display name
            const displayNameLower = displayName.toLowerCase();
            for (let word of inappropriateWords) {
                if (displayNameLower.includes(word)) {
                    return {
                        approved: false,
                        reason: `Display name contains inappropriate content: "${word}". Please choose a family-friendly name.`
                    };
                }
            }
            
            // Check username
            const usernameLower = username.toLowerCase();
            for (let word of reservedWords) {
                if (usernameLower.includes(word)) {
                    return {
                        approved: false,
                        reason: `Username contains reserved terms: "${word}". Please choose a different username.`
                    };
                }
            }
            
            for (let word of inappropriateWords) {
                if (usernameLower.includes(word)) {
                    return {
                        approved: false,
                        reason: `Username contains inappropriate content: "${word}". Please choose a family-friendly username.`
                    };
                }
            }
            
            // Check if username is too short or too long
            if (username.length < 3) {
                return {
                    approved: false,
                    reason: 'Username must be at least 3 characters long.'
                };
            }
            
            if (username.length > 20) {
                return {
                    approved: false,
                    reason: 'Username must be 20 characters or less.'
                };
            }
            
            // Check display name length
            if (displayName.length < 2) {
                return {
                    approved: false,
                    reason: 'Display name must be at least 2 characters long.'
                };
            }
            
            if (displayName.length > 30) {
                return {
                    approved: false,
                    reason: 'Display name must be 30 characters or less.'
                };
            }
            
            return {
                approved: true,
                reason: 'Profile content approved by AI moderation system.'
            };
        }

        function showAIApprovalMessage() {
            const approvalModal = document.createElement('div');
            approvalModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            approvalModal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; animation: pulse 2s infinite;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: bounce 1s infinite;">‚úÖ</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">AI Approved!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1rem; line-height: 1.6;">
                        Your profile has been scanned and approved by our AI moderation system. Welcome to ChatHub! üéâ
                    </p>
                    <div style="width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
                        <div style="width: 100%; height: 100%; background: var(--success-gradient); animation: slideIn 2s ease-out;"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(approvalModal);
            
            setTimeout(() => {
                approvalModal.remove();
            }, 2000);
        }

        function handleSetupProfilePicture(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('setupProfilePreview').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('setupProfilePreview').style.backgroundSize = 'cover';
                    document.getElementById('setupProfilePreview').textContent = '';
                    currentUser.avatar = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function showProfileSetup() {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('profileSetupPage').classList.add('active');
            
            // Pre-fill form with OAuth data
            if (currentUser) {
                document.getElementById('setupDisplayName').value = currentUser.displayName || '';
                document.getElementById('setupUsername').value = currentUser.username || '';
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('chatHubUser');
            document.getElementById('authPage').classList.add('active');
            document.getElementById('chatPage').classList.remove('active');
            document.getElementById('friendsPage').classList.remove('active');
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('navMenu').style.display = 'none';
            document.getElementById('userProfile').style.display = 'none';
        }

        function loadUserData() {
            const savedUser = localStorage.getItem('chatHubUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.setupComplete) {
                    showMainApp();
                } else {
                    showProfileSetup();
                }
            }
            
            // Load theme preference
            const savedTheme = localStorage.getItem('chatHubTheme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.body.setAttribute('data-theme', 'dark');
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.classList.add('active');
                }
            }
        }

        function showMainApp() {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('profileSetupPage').classList.remove('active');
            document.getElementById('chatPage').classList.add('active');
            document.getElementById('navMenu').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'flex';
            
            // Update header with user info
            document.getElementById('headerUsername').textContent = currentUser.displayName || currentUser.username;
            const headerPic = document.getElementById('headerProfilePic');
            if (currentUser.avatar && currentUser.avatar.startsWith('data:')) {
                headerPic.style.backgroundImage = `url(${currentUser.avatar})`;
                headerPic.style.backgroundSize = 'cover';
                headerPic.textContent = '';
            } else {
                headerPic.textContent = currentUser.avatar || 'üë§';
            }
            
            // Populate settings
            document.getElementById('settingsDisplayName').value = currentUser.displayName || '';
            document.getElementById('settingsUsername').value = currentUser.username || '';
            document.getElementById('settingsAllowFriendRequests').checked = currentUser.allowFriendRequests || false;
            
            const profilePreview = document.getElementById('profilePreview');
            if (currentUser.avatar && currentUser.avatar.startsWith('data:')) {
                profilePreview.style.backgroundImage = `url(${currentUser.avatar})`;
                profilePreview.style.backgroundSize = 'cover';
                profilePreview.textContent = '';
            } else {
                profilePreview.textContent = currentUser.avatar || 'üë§';
            }
            
            // Load all data
            populateFriends();
            populateBrowse();
            updateBlockedUsersList();
            populateGroupsList();
            
            // Initialize invite code display
            updateMyInviteCodeDisplay();
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Load page-specific data when navigating
            if (pageId === 'browse') {
                populateBrowse();
            } else if (pageId === 'friends') {
                populateFriends();
                updateMyInviteCodeDisplay();
            } else if (pageId === 'settings') {
                updateBlockedUsersList();
            }
        }

        // Chat functions
        function switchChatTab(tab) {
            const friendsList = document.getElementById('friendsChatList');
            const groupsList = document.getElementById('groupsChatList');
            const tabs = document.querySelectorAll('.chat-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'friends') {
                friendsList.style.display = 'block';
                groupsList.style.display = 'none';
                tabs[0].classList.add('active');
            } else {
                friendsList.style.display = 'none';
                groupsList.style.display = 'block';
                tabs[1].classList.add('active');
            }
        }

        function openChat(type, chatId) {
            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            currentChat = { type, id: chatId };
            
            // Update chat header
            const headerAvatar = document.getElementById('chatHeaderAvatar');
            const headerName = document.getElementById('chatHeaderName');
            const headerStatus = document.getElementById('chatHeaderStatus');
            const headerActions = document.getElementById('chatHeaderActions');
            
            if (type === 'friend') {
                const friendData = getFriendData(chatId);
                headerAvatar.textContent = friendData.avatar;
                headerName.textContent = friendData.name;
                headerStatus.textContent = friendData.status;
                
                // Friend chat actions
                headerActions.innerHTML = `
                    <button class="header-action-btn" onclick="toggleChatInfo()">‚ÑπÔ∏è</button>
                `;
            } else {
                const groupData = getGroupData(chatId);
                headerAvatar.textContent = groupData.avatar;
                headerName.textContent = groupData.name;
                headerStatus.textContent = groupData.memberCount;
                
                // Group chat actions (admin controls)
                if (groupData.isAdmin) {
                    headerActions.innerHTML = `
                        <button class="header-action-btn" onclick="showGroupSettings('${chatId}')" title="Group Settings">‚öôÔ∏è</button>
                        <button class="header-action-btn" onclick="showSelectAdmins('${chatId}')" title="Select Admins">üëë</button>
                        <button class="header-action-btn" onclick="toggleChatInfo()">‚ÑπÔ∏è</button>
                    `;
                } else {
                    headerActions.innerHTML = `
                        <button class="header-action-btn" onclick="toggleChatInfo()">‚ÑπÔ∏è</button>
                    `;
                }
            }
            
            // Show message input and font panel
            document.getElementById('messageInputArea').style.display = 'block';
            document.getElementById('fontPanel').style.display = 'block';
            
            // Load chat messages
            loadChatMessages(type, chatId);
        }

        function getFriendData(friendId) {
            // First check if it's a real friend from our friends list
            const realFriend = myFriends.find(f => f.id === friendId);
            if (realFriend) {
                return {
                    name: realFriend.displayName,
                    avatar: realFriend.avatar,
                    status: 'Online ‚Ä¢ Ready to chat'
                };
            }
            
            // Fallback to demo friends for backwards compatibility
            const friends = {
                'lucas': { name: 'Lucas', avatar: 'üë®‚Äçüíª', status: 'Online ‚Ä¢ Last seen now' },
                'emma': { name: 'Emma', avatar: 'üë©‚Äçüé®', status: 'Online ‚Ä¢ Last seen 2 min ago' },
                'alex': { name: 'Alex', avatar: 'üéÆ', status: 'Offline ‚Ä¢ Last seen 1 hour ago' }
            };
            return friends[friendId] || { name: 'Unknown', avatar: 'üë§', status: 'Offline' };
        }

        function getGroupData(groupId) {
            // Load user groups
            const savedGroups = localStorage.getItem('chatHubUserGroups');
            if (savedGroups) {
                userGroups = JSON.parse(savedGroups);
            }
            
            const group = userGroups.find(g => g.id === groupId);
            if (group) {
                return {
                    name: group.name,
                    avatar: group.avatar,
                    memberCount: `${group.members.length} member${group.members.length !== 1 ? 's' : ''}`,
                    description: group.description || '',
                    isAdmin: group.admins.includes(currentUser.id)
                };
            }
            
            return { name: 'Unknown Group', avatar: 'üë•', memberCount: '0 members', description: '', isAdmin: false };
        }
        
        function populateGroupsList() {
            const groupsList = document.getElementById('groupsChatList');
            const noGroupsMessage = document.getElementById('noGroupsMessage');
            
            // Load user groups
            const savedGroups = localStorage.getItem('chatHubUserGroups');
            if (savedGroups) {
                userGroups = JSON.parse(savedGroups);
            }
            
            // Clear existing groups (except no groups message)
            const existingGroups = groupsList.querySelectorAll('.chat-item');
            existingGroups.forEach(item => item.remove());
            
            if (userGroups.length === 0) {
                noGroupsMessage.style.display = 'block';
                return;
            }
            
            noGroupsMessage.style.display = 'none';
            
            userGroups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'chat-item';
                groupItem.onclick = () => openChat('group', group.id);
                
                const isAdmin = group.admins.includes(currentUser.id);
                const adminBadge = isAdmin ? ' üëë' : '';
                
                groupItem.innerHTML = `
                    <div class="chat-avatar">${group.avatar}</div>
                    <div class="chat-info">
                        <div class="chat-name">${group.name}${adminBadge}</div>
                        <div class="chat-preview">${group.description || 'No description'}</div>
                    </div>
                    <div class="group-count">${group.members.length} member${group.members.length !== 1 ? 's' : ''}</div>
                `;
                
                groupsList.appendChild(groupItem);
            });
        }

        function loadChatMessages(type, chatId) {
            const messagesContainer = document.getElementById('messages');
            const chatKey = `${type}_${chatId}`;
            
            // Clear current messages
            messagesContainer.innerHTML = '';
            
            // Load existing messages or create sample ones
            if (!chatMessages[chatKey]) {
                chatMessages[chatKey] = generateSampleMessages(type, chatId);
            }
            
            chatMessages[chatKey].forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === currentUser?.username ? 'user' : 'other'} font-${msg.font || 'normal'}`;
                if (msg.style) messageDiv.style.cssText = msg.style;
                
                if (msg.type === 'image') {
                    messageDiv.innerHTML = `
                        <strong>${msg.sender}:</strong><br>
                        <img src="${msg.imageData}" alt="${msg.fileName}" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 0.5rem; cursor: pointer;" onclick="showImageModal('${msg.imageData}', '${msg.fileName}')">
                        <div style="font-size: 0.8rem; color: ${msg.sender === currentUser?.username ? 'rgba(255,255,255,0.7)' : '#666'}; margin-top: 0.25rem;">${msg.fileName}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}`;
                }
                
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateSampleMessages(type, chatId) {
            // No demo messages - all chats start empty
            return [];
        }

        function showNoFriendsModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                    <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.5rem; font-weight: 800;">No Friends Yet!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6; font-weight: 600;">
                        You need at least <strong>2 friends</strong> to create a group. Let's add some friends first! üåü
                    </p>
                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin: 0; font-weight: 600;">
                            üí° <strong>How to add friends:</strong><br>
                            ‚Ä¢ Use invite codes on the Friends page<br>
                            ‚Ä¢ Browse people and send friend requests<br>
                            ‚Ä¢ Share your invite code with others
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove(); showPage('friends');" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üë• Add Friends
                        </button>
                        <button onclick="this.closest('div').parentElement.remove();" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showOneFriendModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üë§‚ûï</div>
                    <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.5rem; font-weight: 800;">Need One More Friend!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6; font-weight: 600;">
                        You have <strong>1 friend</strong>, but need at least <strong>2 friends</strong> to create a group. Add one more friend to get started! üéâ
                    </p>
                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                            ${myFriends[0]?.avatar || 'üë§'}
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--text-color);">${myFriends[0]?.displayName || 'Friend'}</div>
                            <div style="font-size: 0.9rem; color: #666; font-weight: 600;">Your current friend ‚úÖ</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove(); showPage('friends');" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            ‚ûï Add More Friends
                        </button>
                        <button onclick="this.closest('div').parentElement.remove();" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showGroupCreationError() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3 style="color: var(--warning-color); margin-bottom: 1rem; font-size: 1.5rem; font-weight: 800;">Select At Least 2 Members!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6; font-weight: 600;">
                        Groups need at least <strong>2 members</strong> (plus you) to be created. Please select at least 2 friends from the list! üë•
                    </p>
                    <div style="background: var(--input-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin: 0; font-weight: 600;">
                            üí° <strong>Tip:</strong> Check the boxes next to your friends' names to select them for the group!
                        </p>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove();" 
                            style="padding: 0.75rem 2rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700;">
                        ‚úÖ Got It
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 4000);
        }

        function showCreateGroup() {
            if (myFriends.length === 0) {
                showNoFriendsModal();
                return;
            }
            
            if (myFriends.length === 1) {
                showOneFriendModal();
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            const friendsCheckboxes = myFriends.map(friend => `
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--input-bg); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--accent-color)'" 
                       onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" name="groupMembers" value="${friend.id}" style="margin: 0;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;">
                        ${friend.avatar}
                    </div>
                    <div>
                        <div style="font-weight: 500; color: var(--text-color);">${friend.displayName}</div>
                        <div style="font-size: 0.9rem; color: #666;">@${friend.username}</div>
                    </div>
                </label>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">üè† Create New Group</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Group Name</label>
                        <input type="text" id="newGroupName" placeholder="Enter group name..." 
                               style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-size: 1rem;" maxlength="50">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Group Description (Optional)</label>
                        <textarea id="newGroupDescription" placeholder="What's this group about?" 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-size: 1rem; resize: vertical; min-height: 80px;" maxlength="200"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 700; color: var(--text-color);">
                            Select Members <span style="color: #666; font-weight: 600;">(minimum 2 required)</span>
                        </label>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                            ${friendsCheckboxes}
                        </div>
                        <div id="memberCount" style="font-size: 0.9rem; color: #666; margin-top: 0.5rem; font-weight: 600;">0 members selected</div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ‚ùå Cancel
                        </button>
                        <button onclick="createGroupFromModal(this)" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üè† Create Group
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners for member selection
            const checkboxes = modal.querySelectorAll('input[name="groupMembers"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateMemberCount);
            });
        }
        
        function updateMemberCount() {
            const checkboxes = document.querySelectorAll('input[name="groupMembers"]:checked');
            const countElement = document.getElementById('memberCount');
            const count = checkboxes.length;
            
            if (countElement) {
                countElement.textContent = `${count} member${count !== 1 ? 's' : ''} selected`;
                countElement.style.color = count >= 2 ? 'var(--success-color)' : '#666';
            }
        }
        
        function createGroupFromModal(button) {
            const groupName = document.getElementById('newGroupName').value.trim();
            const groupDescription = document.getElementById('newGroupDescription').value.trim();
            const selectedMembers = Array.from(document.querySelectorAll('input[name="groupMembers"]:checked')).map(cb => cb.value);
            
            if (!groupName) {
                alert('Please enter a group name!');
                return;
            }
            
            if (selectedMembers.length < 2) {
                // Show better error modal instead of alert
                showGroupCreationError();
                return;
            }
            
            // Check if user has reached group limit
            if (userGroups.length >= 10) {
                alert('You can only create up to 10 groups!');
                return;
            }
            
            button.innerHTML = 'üè† Creating...';
            button.disabled = true;
            
            setTimeout(() => {
                const groupId = 'group_' + Date.now();
                const selectedFriends = myFriends.filter(f => selectedMembers.includes(f.id));
                
                const newGroup = {
                    id: groupId,
                    name: groupName,
                    description: groupDescription || '',
                    avatar: 'üè†',
                    members: [
                        {
                            id: currentUser.id,
                            displayName: currentUser.displayName,
                            username: currentUser.username,
                            avatar: currentUser.avatar,
                            isAdmin: true
                        },
                        ...selectedFriends.map(f => ({
                            id: f.id,
                            displayName: f.displayName,
                            username: f.username,
                            avatar: f.avatar,
                            isAdmin: false
                        }))
                    ],
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString(),
                    admins: [currentUser.id]
                };
                
                userGroups.push(newGroup);
                localStorage.setItem('chatHubUserGroups', JSON.stringify(userGroups));
                
                // Initialize empty messages for this group
                chatMessages[`group_${groupId}`] = [];
                
                // Close modal
                button.closest('div').parentElement.remove();
                
                // Refresh groups list
                populateGroupsList();
                
                // Show success message
                showGroupCreatedSuccess(newGroup);
            }, 1000);
        }
        
        function showGroupCreatedSuccess(group) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: sparkle 2s infinite;">üéâ</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">Group Created! üè†</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6;">
                        <strong>${group.name}</strong> has been created with ${group.members.length} members. You're the admin!
                    </p>
                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                                ${group.avatar}
                            </div>
                            <div style="text-align: left;">
                                <div style="font-weight: 600; color: var(--text-color);">${group.name}</div>
                                <div style="font-size: 0.9rem; color: #666;">${group.members.length} members ‚Ä¢ You're admin</div>
                            </div>
                        </div>
                        ${group.description ? `<p style="color: var(--text-color); font-size: 0.9rem; font-style: italic;">"${group.description}"</p>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove(); openChat('group', '${group.id}');" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üí¨ Start Chatting
                        </button>
                        <button onclick="this.closest('div').parentElement.remove();" 
                                style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                            ‚úÖ Got It
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 5000);
        }

        function toggleChatInfo() {
            if (currentChat) {
                if (currentChat.type === 'friend') {
                    const friendData = getFriendData(currentChat.id);
                    alert(`üë§ ${friendData.name}\nüì± ${friendData.status}\n\nüí¨ You can send messages with different fonts and styles!`);
                } else {
                    const groupData = getGroupData(currentChat.id);
                    alert(`üè† ${groupData.name}\nüë• ${groupData.memberCount}\n\nüí¨ Group chat with multiple friends!`);
                }
            }
        }

        function selectFont(font) {
            currentFont = font;
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            updateInputStyle();
            updatePreview();
        }

        function toggleStyle(style) {
            currentStyles[style] = !currentStyles[style];
            event.target.classList.toggle('active');
            updateInputStyle();
            updatePreview();
        }

        function updateInputStyle() {
            const input = document.getElementById('messageInput');
            let className = `font-${currentFont}`;
            input.className = `message-input ${className}`;
        }

        function updatePreview() {
            const preview = document.getElementById('preview');
            let className = `preview-text font-${currentFont}`;
            let style = '';
            
            if (currentStyles.bold) style += 'font-weight: bold; ';
            if (currentStyles.italic) style += 'font-style: italic; ';
            if (currentStyles.large) style += 'font-size: 1.3rem; ';
            
            preview.className = className;
            preview.style.cssText = style;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB!');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                sendImageMessage(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
            
            // Clear the input
            event.target.value = '';
        }
        
        function sendImageMessage(imageData, fileName) {
            if (!currentUser || !currentChat) return;
            
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <strong>${currentUser.username}:</strong><br>
                <img src="${imageData}" alt="${fileName}" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 0.5rem; cursor: pointer;" onclick="showImageModal('${imageData}', '${fileName}')">
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;">${fileName}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save message
            const chatKey = `${currentChat.type}_${currentChat.id}`;
            if (!chatMessages[chatKey]) chatMessages[chatKey] = [];
            chatMessages[chatKey].push({
                sender: currentUser.username,
                type: 'image',
                imageData: imageData,
                fileName: fileName,
                timestamp: new Date()
            });
        }
        
        function showImageModal(imageData, fileName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="max-width: 90%; max-height: 90%; text-align: center;">
                    <img src="${imageData}" alt="${fileName}" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
                    <div style="color: white; margin-top: 1rem; font-size: 1.1rem;">${fileName}</div>
                    <div style="color: rgba(255,255,255,0.7); margin-top: 0.5rem; font-size: 0.9rem;">Click anywhere to close</div>
                </div>
            `;
            
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message === '' || !currentUser || !currentChat) return;
            
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            let className = `message user font-${currentFont}`;
            let style = '';
            
            if (currentStyles.bold) style += 'font-weight: bold; ';
            if (currentStyles.italic) style += 'font-style: italic; ';
            if (currentStyles.large) style += 'font-size: 1.1rem; ';
            
            messageDiv.className = className;
            messageDiv.style.cssText = style;
            messageDiv.innerHTML = `<strong>${currentUser.username}:</strong> ${message}`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save message
            const chatKey = `${currentChat.type}_${currentChat.id}`;
            if (!chatMessages[chatKey]) chatMessages[chatKey] = [];
            chatMessages[chatKey].push({
                sender: currentUser.username,
                text: message,
                font: currentFont,
                style: style,
                timestamp: new Date()
            });
            
            input.value = '';
            
            // Simulate responses for friends (but not for groups)
            if (currentChat.type === 'friend') {
                setTimeout(() => simulateResponse(currentChat.id), 1000 + Math.random() * 2000);
            }
        }

        function simulateResponse(friendId) {
            const responses = [
                "That's awesome! üòÑ",
                "I totally agree!",
                "Nice font choice! ‚ú®",
                "This chat is so fun!",
                "Love the creativity here! üé®",
                "Great message!",
                "This is so cool! üöÄ",
                "Amazing style! üí´"
            ];
            
            const fonts = ['normal', 'casual', 'tech', 'elegant', 'code'];
            const friendData = getFriendData(friendId);
            
            const randomFont = fonts[Math.floor(Math.random() * fonts.length)];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message other font-${randomFont}`;
            messageDiv.innerHTML = `<strong>${friendData.name}:</strong> ${randomResponse}`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save simulated message
            const chatKey = `friend_${friendId}`;
            if (!chatMessages[chatKey]) chatMessages[chatKey] = [];
            chatMessages[chatKey].push({
                sender: friendData.name,
                text: randomResponse,
                font: randomFont,
                timestamp: new Date()
            });
        }

        // Friends functions
        function populateFriends() {
            const myFriendsGrid = document.getElementById('myFriendsGrid');
            const noFriendsMessage = document.getElementById('noFriendsMessage');
            
            // Load friends from localStorage
            const savedFriends = localStorage.getItem('chatHubMyFriends');
            if (savedFriends) {
                myFriends = JSON.parse(savedFriends);
            }
            
            myFriendsGrid.innerHTML = '';
            
            if (myFriends.length === 0) {
                noFriendsMessage.style.display = 'block';
                return;
            }
            
            noFriendsMessage.style.display = 'none';
            
            myFriends.forEach(friend => {
                const friendCard = document.createElement('div');
                friendCard.className = 'friend-card';
                friendCard.style.cursor = 'pointer';
                friendCard.onclick = () => {
                    showPage('chat');
                    setTimeout(() => openFriendChat(friend), 100);
                };
                
                friendCard.innerHTML = `
                    <div class="friend-avatar">${friend.avatar}</div>
                    <div class="friend-name">${friend.displayName}</div>
                    <div class="friend-status">@${friend.username} ‚Ä¢ Click to chat</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="add-friend-btn" onclick="event.stopPropagation(); openFriendChat('${friend.id}')" style="background: var(--success-gradient);">
                            üí¨ Chat
                        </button>
                        <button class="report-btn" onclick="event.stopPropagation(); blockUser('${friend.id}')" style="background: var(--danger-color);">
                            üö´ Block
                        </button>
                    </div>
                `;
                myFriendsGrid.appendChild(friendCard);
            });
        }

        function openFriendChat(friend) {
            // Switch to chat page and open chat with this friend
            showPage('chat');
            
            // Add friend to chat list if not already there
            const friendsChatList = document.getElementById('friendsChatList');
            
            // Clear existing welcome message
            friendsChatList.innerHTML = '';
            
            // Add friend to chat list
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.onclick = () => openChat('friend', friend.id);
            
            chatItem.innerHTML = `
                <div class="chat-avatar">${friend.avatar}</div>
                <div class="chat-info">
                    <div class="chat-name">${friend.displayName}</div>
                    <div class="chat-preview">Start chatting...</div>
                </div>
                <div class="chat-status online"></div>
            `;
            
            friendsChatList.appendChild(chatItem);
            
            // Auto-open the chat
            setTimeout(() => {
                chatItem.click();
            }, 100);
        }

        function populateBrowse() {
            const browseGrid = document.getElementById('browseGrid');
            const pioneerMessage = document.getElementById('pioneerMessage');
            const browseSearchSection = document.getElementById('browseSearchSection');
            
            // Load blocked users
            const savedBlocked = localStorage.getItem('chatHubBlockedUsers');
            if (savedBlocked) {
                blockedUsers = JSON.parse(savedBlocked);
            }
            
            // Check if current user is the first/only user on the platform
            const allCompletedUsers = allUsers.filter(user => user.setupComplete && user.aiApproved);
            const isFirstUser = allCompletedUsers.length === 0 || (allCompletedUsers.length === 1 && allCompletedUsers[0].id === currentUser.id);
            
            if (isFirstUser) {
                // Show pioneer message for the very first user
                pioneerMessage.style.display = 'block';
                browseSearchSection.style.display = 'none';
                browseGrid.innerHTML = '';
                return;
            }
            
            // Get ALL users who allow friend requests (excluding current user and blocked users)
            // This now shows everyone on the platform, not just those who aren't friends yet
            const availableUsers = allUsers.filter(user => 
                user.allowFriendRequests && 
                user.id !== currentUser.id && 
                user.setupComplete &&
                user.aiApproved &&
                !blockedUsers.includes(user.id)
            );
            
            pioneerMessage.style.display = 'none';
            browseSearchSection.style.display = 'flex';
            
            if (availableUsers.length === 0) {
                browseGrid.innerHTML = '<p style="text-align: center; color: var(--text-color); padding: 2rem;">No people to discover right now. Check back later! üåü</p>';
                return;
            }
            
            browseGrid.innerHTML = '';
            
            availableUsers.forEach(user => {
                const isAlreadyFriend = myFriends.find(f => f.id === user.id);
                
                const friendCard = document.createElement('div');
                friendCard.className = 'friend-card';
                friendCard.style.transform = 'scale(0.95)';
                friendCard.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Add visual indicator for existing friends
                if (isAlreadyFriend) {
                    friendCard.style.border = '2px solid var(--success-color)';
                    friendCard.style.background = 'linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(67, 233, 123, 0.1) 100%)';
                }
                
                friendCard.onmouseenter = () => {
                    friendCard.style.transform = 'scale(1) translateY(-5px)';
                    friendCard.style.boxShadow = 'var(--hover-shadow)';
                };
                
                friendCard.onmouseleave = () => {
                    friendCard.style.transform = 'scale(0.95) translateY(0px)';
                    friendCard.style.boxShadow = 'var(--shadow)';
                };
                
                const buttonContent = isAlreadyFriend 
                    ? `<button class="add-friend-btn" onclick="openFriendChat(${JSON.stringify(user).replace(/"/g, '&quot;')})" style="background: var(--success-gradient); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                           üí¨ Chat
                       </button>`
                    : `<button class="add-friend-btn" onclick="addFriend('${user.id}')" style="background: var(--success-gradient); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                           ‚ûï Add Friend
                       </button>`;
                
                const statusText = isAlreadyFriend ? `@${user.username} ‚Ä¢ Already friends ‚úÖ` : `@${user.username}`;
                
                friendCard.innerHTML = `
                    <div class="friend-avatar" style="background: var(--success-gradient);">${user.avatar}</div>
                    <div class="friend-name">${user.displayName}</div>
                    <div class="friend-status">${statusText}</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        ${buttonContent}
                        <button class="report-btn" onclick="reportUser('${user.id}')" style="background: var(--danger-color); box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);">
                            üö® Report
                        </button>
                    </div>
                `;
                browseGrid.appendChild(friendCard);
            });
        }

        function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            const friendsGrid = document.getElementById('friendsGrid');
            
            if (!searchTerm.trim()) {
                populateFriends();
                return;
            }
            
            const availableUsers = allUsers.filter(user => 
                user.allowFriendRequests && 
                user.id !== currentUser.id && 
                user.setupComplete &&
                (user.displayName.toLowerCase().includes(searchTerm) ||
                 user.username.toLowerCase().includes(searchTerm))
            );
            
            friendsGrid.innerHTML = '';
            
            if (availableUsers.length === 0) {
                friendsGrid.innerHTML = '<p style="text-align: center; color: var(--text-color); padding: 2rem;">No users found matching your search.</p>';
                return;
            }
            
            availableUsers.forEach(user => {
                const friendCard = document.createElement('div');
                friendCard.className = 'friend-card';
                friendCard.innerHTML = `
                    <div class="friend-avatar">${user.avatar}</div>
                    <div class="friend-name">${user.displayName}</div>
                    <div class="friend-status">@${user.username}</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="add-friend-btn" onclick="addFriend('${user.id}')">
                            ‚ûï Add Friend
                        </button>
                        <button class="report-btn" onclick="reportUser('${user.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            üö® Report
                        </button>
                    </div>
                `;
                friendsGrid.appendChild(friendCard);
            });
        }

        function addFriend(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                // Add to friends list
                if (!myFriends.find(f => f.id === userId)) {
                    myFriends.push(user);
                    localStorage.setItem('chatHubMyFriends', JSON.stringify(myFriends));
                    
                    // Show success animation
                    showFriendAddedAnimation(user);
                    
                    // Refresh browse page
                    populateBrowse();
                    populateFriends();
                } else {
                    alert('Already friends with this person! üë•');
                }
            }
        }

        function showFriendAddedAnimation(user) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">Friend Added!</h3>
                    <p style="color: var(--text-color); margin-bottom: 1rem; line-height: 1.6;">
                        You're now friends with <strong>${user.displayName}</strong>! Start chatting from the Friends page. üí¨
                    </p>
                    <button onclick="this.closest('div').parentElement.remove(); showPage('friends');" 
                            style="padding: 0.75rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                        üë• View Friends
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 3000);
        }

        function blockUser(userId) {
            const user = allUsers.find(u => u.id === userId) || myFriends.find(f => f.id === userId);
            if (!user) return;
            
            const confirmBlock = confirm(`Are you sure you want to block ${user.displayName}? This will remove them from your friends list and prevent them from contacting you.`);
            
            if (confirmBlock) {
                // Add to blocked list
                if (!blockedUsers.includes(userId)) {
                    blockedUsers.push(userId);
                    localStorage.setItem('chatHubBlockedUsers', JSON.stringify(blockedUsers));
                }
                
                // Remove from friends list
                myFriends = myFriends.filter(f => f.id !== userId);
                localStorage.setItem('chatHubMyFriends', JSON.stringify(myFriends));
                
                // Show blocked message
                showBlockedAnimation(user);
                
                // Refresh pages
                populateFriends();
                populateBrowse();
                updateBlockedUsersList();
            }
        }

        function showBlockedAnimation(user) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üö´</div>
                    <h3 style="color: var(--danger-color); margin-bottom: 1rem; font-size: 1.5rem;">User Blocked</h3>
                    <p style="color: var(--text-color); margin-bottom: 1rem; line-height: 1.6;">
                        <strong>${user.displayName}</strong> has been blocked. You can unblock them from Settings if needed.
                    </p>
                    <button onclick="this.closest('div').parentElement.remove();" 
                            style="padding: 0.75rem 2rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                        ‚úÖ Understood
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 3000);
        }

        function searchBrowse() {
            const searchTerm = document.getElementById('browseSearch').value.toLowerCase();
            const browseGrid = document.getElementById('browseGrid');
            
            if (!searchTerm.trim()) {
                populateBrowse();
                return;
            }
            
            // Load blocked users
            const savedBlocked = localStorage.getItem('chatHubBlockedUsers');
            if (savedBlocked) {
                blockedUsers = JSON.parse(savedBlocked);
            }
            
            // Search ALL users who allow friend requests (including existing friends)
            const availableUsers = allUsers.filter(user => 
                user.allowFriendRequests && 
                user.id !== currentUser.id && 
                user.setupComplete &&
                user.aiApproved &&
                !blockedUsers.includes(user.id) &&
                (user.displayName.toLowerCase().includes(searchTerm) ||
                 user.username.toLowerCase().includes(searchTerm))
            );
            
            browseGrid.innerHTML = '';
            
            if (availableUsers.length === 0) {
                browseGrid.innerHTML = '<p style="text-align: center; color: var(--text-color); padding: 2rem;">No users found matching your search. üîç</p>';
                return;
            }
            
            availableUsers.forEach(user => {
                const isAlreadyFriend = myFriends.find(f => f.id === user.id);
                
                const friendCard = document.createElement('div');
                friendCard.className = 'friend-card';
                friendCard.style.transform = 'scale(0.95)';
                friendCard.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Add visual indicator for existing friends
                if (isAlreadyFriend) {
                    friendCard.style.border = '2px solid var(--success-color)';
                    friendCard.style.background = 'linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(67, 233, 123, 0.1) 100%)';
                }
                
                friendCard.onmouseenter = () => {
                    friendCard.style.transform = 'scale(1) translateY(-5px)';
                    friendCard.style.boxShadow = 'var(--hover-shadow)';
                };
                
                friendCard.onmouseleave = () => {
                    friendCard.style.transform = 'scale(0.95) translateY(0px)';
                    friendCard.style.boxShadow = 'var(--shadow)';
                };
                
                const buttonContent = isAlreadyFriend 
                    ? `<button class="add-friend-btn" onclick="openFriendChat(${JSON.stringify(user).replace(/"/g, '&quot;')})" style="background: var(--success-gradient); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                           üí¨ Chat
                       </button>`
                    : `<button class="add-friend-btn" onclick="addFriend('${user.id}')" style="background: var(--success-gradient); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                           ‚ûï Add Friend
                       </button>`;
                
                const statusText = isAlreadyFriend ? `@${user.username} ‚Ä¢ Already friends ‚úÖ` : `@${user.username}`;
                
                friendCard.innerHTML = `
                    <div class="friend-avatar" style="background: var(--success-gradient);">${user.avatar}</div>
                    <div class="friend-name">${user.displayName}</div>
                    <div class="friend-status">${statusText}</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        ${buttonContent}
                        <button class="report-btn" onclick="reportUser('${user.id}')" style="background: var(--danger-color); box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);">
                            üö® Report
                        </button>
                    </div>
                `;
                browseGrid.appendChild(friendCard);
            });
        }

        function generateMyInviteCode() {
            if (!currentUser) return null;
            
            // Generate a simple, memorable invite code based on user ID
            const userId = currentUser.id.toString();
            const hash = userId.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            
            // Convert to a 6-character alphanumeric code
            const code = Math.abs(hash).toString(36).toUpperCase().substring(0, 6).padEnd(6, '0');
            return code;
        }

        function showMyInviteCode() {
            const code = generateMyInviteCode();
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üé´</div>
                    <h3 style="color: var(--text-color); margin-bottom: 1rem;">Your Invite Code</h3>
                    <div style="background: var(--input-bg); padding: 2rem; border-radius: 12px; border: 2px solid var(--accent-color); margin-bottom: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-color); font-family: 'Courier Prime', monospace; letter-spacing: 3px;">
                            ${code}
                        </div>
                    </div>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.5;">
                        Share this code with friends! When they enter it, you'll automatically become friends.
                    </p>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button onclick="copyToClipboard('${code}'); showCopySuccess();" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            üìã Copy Code
                        </button>
                        <button onclick="this.closest('div').parentElement.remove();" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ‚úÖ Done
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function copyMyInviteCode() {
            const code = generateMyInviteCode();
            copyToClipboard(code);
            showCopySuccess();
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        function showCopySuccess() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: var(--success-gradient); 
                color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 1001;
                animation: slideIn 0.3s ease-out; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
            `;
            toast.innerHTML = 'üìã Code copied to clipboard!';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function useInviteCode() {
            const codeInput = document.getElementById('friendInviteCode');
            const enteredCode = codeInput.value.trim().toUpperCase();
            
            if (!enteredCode) {
                alert('Please enter an invite code!');
                return;
            }
            
            if (enteredCode.length !== 6) {
                alert('Invite codes are 6 characters long. Please check and try again.');
                return;
            }
            
            // Check if it's the user's own code
            const myCode = generateMyInviteCode();
            if (enteredCode === myCode) {
                alert("You can't use your own invite code! üòÑ");
                return;
            }
            
            // Find the user with this invite code
            const friendUser = allUsers.find(user => {
                if (!user.setupComplete || !user.aiApproved) return false;
                const userCode = generateInviteCodeForUser(user);
                return userCode === enteredCode;
            });
            
            if (!friendUser) {
                alert('Invalid invite code! Please check the code and try again.');
                return;
            }
            
            // Check if already friends
            if (myFriends.find(f => f.id === friendUser.id)) {
                alert(`You're already friends with ${friendUser.displayName}! üë•`);
                return;
            }
            
            // Check if user is blocked
            if (blockedUsers.includes(friendUser.id)) {
                alert('This user is blocked. Unblock them first to add as friend.');
                return;
            }
            
            // Add as friend
            myFriends.push(friendUser);
            localStorage.setItem('chatHubMyFriends', JSON.stringify(myFriends));
            
            // Clear the input
            codeInput.value = '';
            
            // Show success animation
            showFriendAddedViaCode(friendUser);
            
            // Refresh pages
            populateFriends();
            populateBrowse();
        }

        function generateInviteCodeForUser(user) {
            const userId = user.id.toString();
            const hash = userId.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            
            return Math.abs(hash).toString(36).toUpperCase().substring(0, 6).padEnd(6, '0');
        }

        function showFriendAddedViaCode(user) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 450px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: sparkle 2s infinite;">üéâ</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">Friend Added! ü§ù</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6;">
                        You're now friends with <strong>${user.displayName}</strong>! You can start chatting right away.
                    </p>
                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                            ${user.avatar}
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: var(--text-color);">${user.displayName}</div>
                            <div style="font-size: 0.9rem; color: #666;">@${user.username}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove(); showPage('chat'); setTimeout(() => openFriendChat(${JSON.stringify(user).replace(/"/g, '&quot;')}), 100);" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üí¨ Start Chatting
                        </button>
                        <button onclick="this.closest('div').parentElement.remove(); showPage('friends');" 
                                style="padding: 0.75rem 1.5rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                            üë• View Friends
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 5000);
        }

        function generateInviteCode() {
            // Generate a unique invite code based on user ID and timestamp
            const timestamp = Date.now();
            const userPart = currentUser.id.toString(36);
            const randomPart = Math.random().toString(36).substring(2, 8);
            return `${userPart}-${timestamp.toString(36)}-${randomPart}`;
        }

        function saveInviteCode(inviteCode) {
            // Save invite code with user info for tracking
            const inviteCodes = JSON.parse(localStorage.getItem('chatHubInviteCodes') || '{}');
            inviteCodes[inviteCode] = {
                inviterId: currentUser.id,
                inviterName: currentUser.displayName,
                inviterUsername: currentUser.username,
                createdAt: new Date().toISOString(),
                used: false
            };
            localStorage.setItem('chatHubInviteCodes', JSON.stringify(inviteCodes));
        }

        function copyInviteToClipboard(inviteText) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(inviteText).then(() => {
                    showInviteSharedSuccess();
                }).catch(() => {
                    showInviteFallback(inviteText);
                });
            } else {
                showInviteFallback(inviteText);
            }
        }

        function showInviteSharedSuccess() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; animation: bounce 0.5s ease-out;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; animation: sparkle 2s infinite;">‚ú®</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">Invite Shared! üéâ</h3>
                    <p style="color: var(--text-color); margin-bottom: 1.5rem; line-height: 1.6;">
                        Your personalized invite link has been copied to clipboard! Share it with friends to grow your ChatHub community.
                    </p>
                    <div style="background: var(--input-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">üí° Pro Tip:</p>
                        <p style="color: var(--text-color); font-size: 0.9rem; line-height: 1.4;">
                            When someone joins using your link, they'll automatically be added to your friends list!
                        </p>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="padding: 0.75rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                        üöÄ Awesome!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 4000);
        }

        function showInviteFallback(inviteText) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%;">
                    <h3 style="margin-bottom: 1rem; color: var(--text-color); text-align: center;">üì§ Share Your Invite</h3>
                    <p style="color: var(--text-color); margin-bottom: 1rem; text-align: center;">
                        Copy this message and share it with your friends:
                    </p>
                    <textarea readonly style="width: 100%; height: 120px; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-family: inherit; resize: none; margin-bottom: 1rem;">${inviteText}</textarea>
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button onclick="navigator.clipboard.writeText(\`${inviteText.replace(/`/g, '\\`')}\`).then(() => alert('Copied! üìã'))" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            üìã Copy Text
                        </button>
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ‚úÖ Done
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function updateMyInviteCodeDisplay() {
            const codeElement = document.getElementById('myInviteCode');
            if (codeElement && currentUser) {
                const code = generateMyInviteCode();
                codeElement.textContent = code;
            }
        }

        function showFirstUserTips() {
            const tipsModal = document.createElement('div');
            tipsModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            tipsModal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">üí° Getting Started with ChatHub</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üé® <span>Express Yourself</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin-left: 1.5rem;">
                            Use different fonts and styles to make your messages unique! Try casual, tech, elegant, or code fonts.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üë• <span>Build Your Community</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin-left: 1.5rem;">
                            Share your invite link with friends, family, and colleagues. The more people join, the more fun it gets!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üè† <span>Create Groups</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin-left: 1.5rem;">
                            Once you have friends, create groups for different topics - work, gaming, family, or hobbies!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üõ°Ô∏è <span>Stay Safe</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.4; margin-left: 1.5rem;">
                            Use the report feature if you encounter inappropriate content. Our AI helps keep the community safe!
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.75rem 2rem; background: var(--primary-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            üöÄ Let's Get Started!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tipsModal);
        }

        // Settings functions
        function handleProfilePicture(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // In a real app, you'd upload this to a server
                    // For demo, we'll just show a placeholder
                    document.getElementById('profilePreview').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('profilePreview').style.backgroundSize = 'cover';
                    document.getElementById('profilePreview').textContent = '';
                };
                reader.readAsDataURL(file);
            }
        }



        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const toggle = document.getElementById('themeToggle');
            
            if (isDarkMode) {
                document.body.setAttribute('data-theme', 'dark');
                toggle.classList.add('active');
                localStorage.setItem('chatHubTheme', 'dark');
            } else {
                document.body.setAttribute('data-theme', 'light');
                toggle.classList.remove('active');
                localStorage.setItem('chatHubTheme', 'light');
            }
        }

        function updateBlockedUsersList() {
            const blockedList = document.getElementById('blockedUsersList');
            
            // Load blocked users
            const savedBlocked = localStorage.getItem('chatHubBlockedUsers');
            if (savedBlocked) {
                blockedUsers = JSON.parse(savedBlocked);
            }
            
            if (blockedUsers.length === 0) {
                blockedList.innerHTML = '<p style="color: #666; font-style: italic;">No blocked users</p>';
                return;
            }
            
            blockedList.innerHTML = '';
            
            blockedUsers.forEach(userId => {
                const user = allUsers.find(u => u.id === userId);
                if (user) {
                    const blockedItem = document.createElement('div');
                    blockedItem.style.cssText = `
                        display: flex; align-items: center; justify-content: space-between; 
                        padding: 1rem; background: var(--input-bg); border-radius: 8px; 
                        margin-bottom: 0.5rem; border: 1px solid var(--border-color);
                    `;
                    
                    blockedItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                ${user.avatar}
                            </div>
                            <div>
                                <div style="font-weight: 500; color: var(--text-color);">${user.displayName}</div>
                                <div style="font-size: 0.9rem; color: #666;">@${user.username}</div>
                            </div>
                        </div>
                        <button onclick="unblockUser('${userId}')" 
                                style="padding: 0.5rem 1rem; background: var(--success-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                            üîì Unblock
                        </button>
                    `;
                    
                    blockedList.appendChild(blockedItem);
                }
            });
        }

        function unblockUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const confirmUnblock = confirm(`Are you sure you want to unblock ${user.displayName}? They will be able to contact you again.`);
            
            if (confirmUnblock) {
                // Remove from blocked list
                blockedUsers = blockedUsers.filter(id => id !== userId);
                localStorage.setItem('chatHubBlockedUsers', JSON.stringify(blockedUsers));
                
                // Show success message
                showUnblockedAnimation(user);
                
                // Refresh lists
                updateBlockedUsersList();
                populateBrowse();
            }
        }

        function showUnblockedAnimation(user) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 3rem; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üîì</div>
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.5rem;">User Unblocked</h3>
                    <p style="color: var(--text-color); margin-bottom: 1rem; line-height: 1.6;">
                        <strong>${user.displayName}</strong> has been unblocked. You can now interact with them again.
                    </p>
                    <button onclick="this.closest('div').parentElement.remove();" 
                            style="padding: 0.75rem 2rem; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 500;">
                        ‚úÖ Got It
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.remove();
            }, 3000);
        }
        
        function showGroupSettings(groupId) {
            const group = userGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">‚öôÔ∏è Group Settings</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Group Name</label>
                        <input type="text" id="editGroupName" value="${group.name}" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-size: 1rem;" maxlength="50">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Group Description</label>
                        <textarea id="editGroupDescription" placeholder="What's this group about?" 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); font-size: 1rem; resize: vertical; min-height: 80px;" maxlength="200">${group.description || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Group Avatar</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${['üè†', 'üíº', 'üéÆ', 'üé®', 'üìö', 'üçï', '‚öΩ', 'üéµ', 'üåü', 'üöÄ'].map(emoji => 
                                `<button onclick="selectGroupAvatar('${emoji}', this)" 
                                         style="padding: 0.75rem; border: 2px solid ${group.avatar === emoji ? 'var(--accent-color)' : 'var(--border-color)'}; border-radius: 8px; background: var(--input-bg); cursor: pointer; font-size: 1.5rem; transition: all 0.2s;"
                                         ${group.avatar === emoji ? 'class="selected-avatar"' : ''}>
                                    ${emoji}
                                </button>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-color); margin-bottom: 0.75rem;">Members (${group.members.length})</h4>
                        <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                            ${group.members.map(member => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--input-bg); border-radius: 6px; margin-bottom: 0.25rem;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1rem; color: white;">
                                            ${member.avatar}
                                        </div>
                                        <div>
                                            <div style="font-weight: 500; color: var(--text-color);">${member.displayName} ${member.isAdmin ? 'üëë' : ''}</div>
                                            <div style="font-size: 0.8rem; color: #666;">@${member.username}</div>
                                        </div>
                                    </div>
                                    ${member.id !== currentUser.id ? `
                                        <button onclick="removeMemberFromGroup('${groupId}', '${member.id}')" 
                                                style="padding: 0.25rem 0.5rem; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                            Remove
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ‚ùå Cancel
                        </button>
                        <button onclick="saveGroupSettings('${groupId}', this)" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üíæ Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function selectGroupAvatar(emoji, button) {
            // Remove selection from all avatar buttons
            const avatarButtons = button.parentElement.querySelectorAll('button');
            avatarButtons.forEach(btn => {
                btn.style.borderColor = 'var(--border-color)';
                btn.classList.remove('selected-avatar');
            });
            
            // Select this avatar
            button.style.borderColor = 'var(--accent-color)';
            button.classList.add('selected-avatar');
        }
        
        function saveGroupSettings(groupId, button) {
            const newName = document.getElementById('editGroupName').value.trim();
            const newDescription = document.getElementById('editGroupDescription').value.trim();
            const selectedAvatar = document.querySelector('.selected-avatar')?.textContent || 'üè†';
            
            if (!newName) {
                alert('Please enter a group name!');
                return;
            }
            
            button.innerHTML = 'üíæ Saving...';
            button.disabled = true;
            
            setTimeout(() => {
                // Update group
                const groupIndex = userGroups.findIndex(g => g.id === groupId);
                if (groupIndex >= 0) {
                    userGroups[groupIndex].name = newName;
                    userGroups[groupIndex].description = newDescription;
                    userGroups[groupIndex].avatar = selectedAvatar;
                    
                    localStorage.setItem('chatHubUserGroups', JSON.stringify(userGroups));
                    
                    // Update UI
                    populateGroupsList();
                    
                    // Update chat header if this group is currently open
                    if (currentChat && currentChat.type === 'group' && currentChat.id === groupId) {
                        document.getElementById('chatHeaderAvatar').textContent = selectedAvatar;
                        document.getElementById('chatHeaderName').textContent = newName;
                    }
                    
                    // Close modal
                    button.closest('div').parentElement.remove();
                    
                    // Show success message
                    showGroupSettingsSaved();
                }
            }, 1000);
        }
        
        function showGroupSettingsSaved() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: var(--success-gradient); 
                color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 1001;
                animation: slideIn 0.3s ease-out; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
            `;
            toast.innerHTML = '‚úÖ Group settings saved!';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function showSelectAdmins(groupId) {
            const group = userGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            const membersCheckboxes = group.members.filter(m => m.id !== currentUser.id).map(member => `
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--input-bg); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--accent-color)'" 
                       onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" name="groupAdmins" value="${member.id}" ${member.isAdmin ? 'checked' : ''} style="margin: 0;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--success-gradient); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;">
                        ${member.avatar}
                    </div>
                    <div>
                        <div style="font-weight: 500; color: var(--text-color);">${member.displayName} ${member.isAdmin ? 'üëë' : ''}</div>
                        <div style="font-size: 0.9rem; color: #666;">@${member.username}</div>
                    </div>
                </label>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-color); text-align: center;">üëë Select Admins</h3>
                    
                    <div style="background: var(--input-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <p style="color: var(--text-color); font-size: 0.9rem; margin: 0; line-height: 1.4;">
                            <strong>Admin Privileges:</strong><br>
                            ‚Ä¢ Change group name, description, and avatar<br>
                            ‚Ä¢ Add/remove members<br>
                            ‚Ä¢ Select other admins<br>
                            ‚Ä¢ Manage group settings
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                            Select Members to Make Admins
                        </label>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                            ${membersCheckboxes}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; justify-content: center;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="padding: 0.75rem 1.5rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            ‚ùå Cancel
                        </button>
                        <button onclick="saveGroupAdmins('${groupId}', this)" 
                                style="padding: 0.75rem 1.5rem; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                            üëë Update Admins
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function saveGroupAdmins(groupId, button) {
            const selectedAdmins = Array.from(document.querySelectorAll('input[name="groupAdmins"]:checked')).map(cb => cb.value);
            
            button.innerHTML = 'üëë Updating...';
            button.disabled = true;
            
            setTimeout(() => {
                // Update group admins
                const groupIndex = userGroups.findIndex(g => g.id === groupId);
                if (groupIndex >= 0) {
                    // Reset all members to non-admin (except creator)
                    userGroups[groupIndex].members.forEach(member => {
                        if (member.id === currentUser.id) {
                            member.isAdmin = true; // Creator always remains admin
                        } else {
                            member.isAdmin = selectedAdmins.includes(member.id);
                        }
                    });
                    
                    // Update admins array
                    userGroups[groupIndex].admins = [currentUser.id, ...selectedAdmins];
                    
                    localStorage.setItem('chatHubUserGroups', JSON.stringify(userGroups));
                    
                    // Update UI
                    populateGroupsList();
                    
                    // Close modal
                    button.closest('div').parentElement.remove();
                    
                    // Show success message
                    showAdminsUpdated(selectedAdmins.length);
                }
            }, 1000);
        }
        
        function showAdminsUpdated(adminCount) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: var(--success-gradient); 
                color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 1001;
                animation: slideIn 0.3s ease-out; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
            `;
            toast.innerHTML = `üëë ${adminCount} admin${adminCount !== 1 ? 's' : ''} updated!`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function saveSettings() {
            if (currentUser) {
                const newDisplayName = document.getElementById('settingsDisplayName').value;
                const newUsername = document.getElementById('settingsUsername').value;
                const newAllowFriendRequests = document.getElementById('settingsAllowFriendRequests').checked;
                
                // Check if username is taken by someone else
                if (allUsers.find(u => u.username === newUsername && u.id !== currentUser.id)) {
                    alert('Username is already taken! Please choose another one.');
                    return;
                }
                
                currentUser.displayName = newDisplayName;
                currentUser.username = newUsername;
                currentUser.allowFriendRequests = newAllowFriendRequests;
                
                // Update in allUsers array
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                if (userIndex >= 0) {
                    allUsers[userIndex] = currentUser;
                    saveAllUsers();
                }
                
                localStorage.setItem('chatHubUser', JSON.stringify(currentUser));
                document.getElementById('headerUsername').textContent = currentUser.displayName || currentUser.username;
                
                // Refresh friends list in case visibility changed
                populateFriends();
                
                alert('Settings saved successfully! ‚úÖ');
            }
        }

        // PWA functions
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('installBtn').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'chathub-v2';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    return response || fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970bf1cdf1fff9eb',t:'MTc1NTQ2Mjc4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
